<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DexaGen-AI | Clinical Research Assistant</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- 3D Engines -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
            --glass-bg: rgba(255, 255, 255, 0.90);
            --accent-color: #4e54c8;
        }

        body {
            background: #f3f4f6;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234e54c8' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            font-family: 'Poppins', sans-serif;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navbar */
        .navbar { background: white; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .navbar-brand { font-weight: 600; color: var(--accent-color) !important; }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        /* Inputs */
        .form-control-lg {
            border-radius: 12px; border: 2px solid #e9ecef; padding: 12px; font-size: 0.95rem;
        }
        .form-control-lg:focus {
            border-color: var(--accent-color); box-shadow: 0 0 0 0.25rem rgba(78, 84, 200, 0.15);
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary-gradient); border: none; padding: 12px; border-radius: 12px;
            font-weight: 600; transition: all 0.3s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(78, 84, 200, 0.3); }
        
        .btn-chip {
            border-radius: 50px; padding: 5px 15px; font-size: 0.8rem; border: 1px solid #dee2e6;
            background: white; color: #666; transition: all 0.2s; margin-right: 5px; margin-bottom: 5px;
        }
        .btn-chip:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }

        /* AI Buttons */
        .btn-ai {
            background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);
            color: white; border: none; font-size: 0.75rem; border-radius: 8px; padding: 6px 12px;
            font-weight: 600; margin-left: 5px; transition: all 0.3s;
        }
        .btn-ai:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(255, 94, 98, 0.3); color: white; }

        /* Toggle Tabs */
        .nav-pills .nav-link.active { background-color: var(--accent-color); }
        .nav-pills .nav-link { color: #666; font-weight: 600; font-size: 0.9rem; }

        /* 3D Viewer Area */
        .viewer-container {
            height: 400px; width: 100%; position: relative; background: #000; border-radius: 15px; overflow: hidden;
            border: 4px solid #fff; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .viewer_3d { width: 100%; height: 100%; }

        /* Audio Wave */
        .audio-wave { display: inline-flex; align-items: center; height: 20px; }
        .bar {
            background: var(--accent-color); width: 3px; height: 10px; margin: 0 2px; border-radius: 5px;
            animation: sound 0ms -800ms linear infinite alternate;
        }
        .speaking .bar { animation-duration: 400ms; }
        @keyframes sound { 0% { height: 3px; opacity: .35; } 100% { height: 100%; opacity: 1; } }

        /* Flow Tracker */
        .flow-step { opacity: 0.4; transition: all 0.5s; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; }
        .flow-active { opacity: 1; color: var(--accent-color); transform: scale(1.1); }
        .flow-icon { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .flow-active .flow-icon { background: var(--accent-color); color: white; }

        /* Markdown-like output for AI */
        .ai-content h1, .ai-content h2, .ai-content h3 { font-size: 1rem; font-weight: bold; margin-top: 10px; color: #333; }
        .ai-content ul { padding-left: 20px; }
        .ai-content strong { color: var(--accent-color); }

        footer { margin-top: auto; background: white; padding: 20px 0; border-top: 1px solid #eee; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fa-solid fa-dna me-2"></i>DexaGen-AI</a>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-light text-dark border d-none d-sm-block">CLINICAL TOOL</span>
                <span class="badge" style="background: linear-gradient(135deg, #FF9966 0%, #FF5E62 100%);"><i class="fa-solid fa-sparkles me-1"></i> DEXAGEN AI</span>
            </div>
        </div>
    </nav>

    <div class="container my-5 flex-grow-1">
        <div class="row g-4">
            <!-- LEFT COLUMN: CONTROLS -->
            <div class="col-lg-4">
                <div class="glass-card p-4 h-100">
                    <h5 class="fw-bold text-secondary mb-4"><i class="fa-solid fa-sliders me-2"></i>DEXAGEN AI:Analysis Parameters</h5>
                    
                    <!-- Mode Switch -->
                    <ul class="nav nav-pills nav-fill mb-4" id="modeTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="tab-single" onclick="setMode('single')" href="#">Single Drug</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="tab-dual" onclick="setMode('dual')" href="#">Interaction</a>
                        </li>
                    </ul>

                    <!-- Single Form -->
                    <form id="singleForm">
                        <label class="form-label small text-muted text-uppercase fw-bold">Target Molecule</label>
                        <input type="text" class="form-control form-control-lg mb-3" id="smilesInput" placeholder="e.g. Dexamethasone">
                        
                        <div class="mb-4">
                            <button type="button" class="btn btn-chip" onclick="fill('Aspirin')">Aspirin</button>
                            <button type="button" class="btn btn-chip" onclick="fill('Cortisol')">Cortisol</button>
                            <button type="button" class="btn btn-chip" onclick="fill('Prednisone')">Prednisone</button>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            RUN ANALYSIS SIMULATION  <i class="fa-solid fa-microscope ms-2"></i>
                        </button>
                    </form>

                    <!-- Dual Form -->
                    <form id="dualForm" class="d-none">
                        <label class="form-label small text-muted text-uppercase fw-bold">Primary Agent</label>
                        <input type="text" class="form-control form-control-lg mb-2" id="drugA" value="Dexamethasone">
                        
                        <div class="text-center my-2 text-muted"><i class="fa-solid fa-plus-circle"></i></div>
                        
                        <label class="form-label small text-muted text-uppercase fw-bold">Secondary Agent</label>
                        <input type="text" class="form-control form-control-lg mb-4" id="drugB" placeholder="e.g. Ibuprofen">

                        <button type="submit" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            ANALYZE INTERACTION <i class="fa-solid fa-circle-nodes ms-2"></i>
                        </button>
                    </form>

                    <!-- Voice Control -->
                    <div class="mt-4 pt-3 border-top d-flex justify-content-between align-items-center">
                        <span class="small text-muted"><i class="fa-solid fa-headset me-1"></i> Research Voice</span>
                        <div class="d-flex align-items-center">
                            <div id="audioVisualizer" class="audio-wave me-2"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                            <button id="muteBtn" class="btn btn-sm btn-light rounded-circle border" onclick="toggleVoice()">
                                <i class="fa-solid fa-volume-high text-primary"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: RESULTS & 3D -->
            <div class="col-lg-8">
                <!-- 3D Viewer Card -->
                <div class="glass-card mb-4" style="min-height: 400px;">
                    <div class="viewer-container">
                        <div id="gldiv" class="viewer_3d"></div>
                        <!-- Overlay -->
                        <div class="position-absolute bottom-0 start-0 p-3 text-white pointer-events-none">
                            <span class="badge bg-primary bg-opacity-75"><i class="fa-solid fa-cube me-1"></i> LIVE 3D RENDER</span>
                        </div>
                        <div id="loadingOverlay" class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-none flex-column align-items-center justify-content-center z-3">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                            <div class="mt-3 text-white small fw-bold ls-1">RENDERING PHYSICS...</div>
                        </div>
                    </div>
                </div>

                <!-- Report Card -->
                <div class="glass-card p-4 animate__animated animate__fadeInUp">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0 fw-bold text-secondary me-3"><i class="fa-solid fa-file-medical-alt me-2"></i>Biological Mechanism</h5>
                        </div>
                        <div class="d-flex gap-2 mt-2 mt-sm-0">
                            <button onclick="askGemini('patient')" class="btn btn-ai shadow-sm"><i class="fa-solid fa-user-injured me-1"></i> Explain to Patient</button>
                            <button onclick="askGemini('research')" class="btn btn-ai shadow-sm"><i class="fa-solid fa-microscope me-1"></i> Clinical Deep Dive</button>
                            <button onclick="speakReport()" class="btn btn-sm btn-light border text-secondary ms-1"><i class="fa-solid fa-play"></i></button>
                        </div>
                    </div>

                    <!-- Flow Tracker -->
                    <div class="d-flex justify-content-between text-center mb-4 px-3">
                        <div id="step1" class="flow-step"><div class="flow-icon mx-auto"><i class="fa-solid fa-shield-virus"></i></div>Membrane</div>
                        <div id="step2" class="flow-step"><div class="flow-icon mx-auto"><i class="fa-solid fa-dna"></i></div>Cytoplasm</div>
                        <div id="step3" class="flow-step"><div class="flow-icon mx-auto"><i class="fa-solid fa-bullseye"></i></div>Nucleus</div>
                        <div id="step4" class="flow-step"><div class="flow-icon mx-auto"><i class="fa-solid fa-file-signature"></i></div>Transcript</div>
                    </div>

                    <div class="p-3 bg-white rounded-4 border position-relative">
                        <div id="aiLoading" class="position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-none flex-column align-items-center justify-content-center z-2 rounded-4">
                            <div class="spinner-grow text-warning" role="status"></div>
                            <small class="mt-2 text-muted fw-bold">Gemini is analyzing...</small>
                        </div>
                        <div id="reportText" class="text-secondary mb-0 ai-content" style="line-height: 1.7; white-space: pre-line;">
                            System Ready. Select a compound to begin simulation.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center">
        <div class="container">
            <p class="mb-0 text-muted">&copy; 2025 DexaGen-AI. Research Assistant by Prof Abonyo.</p>
        </div>
    </footer>

    <script>
        // --- 1. CONFIGURATION ---
        const apiKey = "AIzaSyAF2gOUOASn6p3v_IsDSqfBB1apoEFzloo"; 
        let element = $('#gldiv');
        let config = { backgroundColor: 'black' };
        let viewer = $3Dmol.createViewer( element, config );
        let synth = window.speechSynthesis;
        let isMuted = false;
        let lastAnalysis = ""; // Store for AI context

        function setMode(mode) {
            $('.nav-link').removeClass('active');
            if(mode === 'single') {
                $('#singleForm').removeClass('d-none'); $('#dualForm').addClass('d-none');
                $('#tab-single').addClass('active');
            } else {
                $('#singleForm').addClass('d-none'); $('#dualForm').removeClass('d-none');
                $('#tab-dual').addClass('active');
            }
        }

        function fill(name) { $('#smilesInput').val(name); }

        function toggleVoice() {
            isMuted = !isMuted;
            const btn = $('#muteBtn i');
            if(isMuted) {
                synth.cancel();
                btn.removeClass('fa-volume-high text-primary').addClass('fa-volume-xmark text-danger');
                $('#audioVisualizer').removeClass('speaking');
            } else {
                btn.removeClass('fa-volume-xmark text-danger').addClass('fa-volume-high text-primary');
            }
        }

        function updateFlowTracker(active) {
            $('.flow-active').removeClass('flow-active');
            if(!active) return;
            // Animation Sequence
            setTimeout(() => $('#step1').addClass('flow-active'), 500);
            setTimeout(() => $('#step2').addClass('flow-active'), 2000);
            setTimeout(() => $('#step3').addClass('flow-active'), 3500);
            setTimeout(() => $('#step4').addClass('flow-active'), 5000);
        }

        // --- 2. LOGIC HANDLERS ---
        $('#singleForm').on('submit', e => { e.preventDefault(); runSim('/predict', { smiles: $('#smilesInput').val() }); });
        $('#dualForm').on('submit', e => { e.preventDefault(); runSim('/predict_interaction', { drug_a: $('#drugA').val(), drug_b: $('#drugB').val() }); });

        async function runSim(endpoint, payload) {
            $('#loadingOverlay').removeClass('d-none').addClass('d-flex');
            synth.cancel();
            $('.flow-active').removeClass('flow-active');

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                $('#loadingOverlay').addClass('d-none').removeClass('d-flex');

                if(data.error) {
                    $('#reportText').html(`<span class="text-danger fw-bold">Error:</span> ${data.error}`);
                    return;
                }

                // Store for AI
                lastAnalysis = `Drug(s): ${JSON.stringify(payload)}. Mechanism: ${data.message}`;
                
                $('#reportText').text(data.message);
                
                // Flow Animation
                if (data.flow_active || endpoint.includes('interaction')) updateFlowTracker(true);

                // 3D Rendering
                viewer.clear();
                if (data.mol_3d) {
                    viewer.addModel(data.mol_3d, "sdf");
                    viewer.setStyle({}, {stick: {colorscheme: "Jmol", radius: 0.15}});
                } else if (data.mol_3d_a && data.mol_3d_b) {
                    let m1 = viewer.addModel(data.mol_3d_a, "sdf");
                    let m2 = viewer.addModel(data.mol_3d_b, "sdf");
                    viewer.setStyle({}, {stick: {radius: 0.15}});
                    m1.setStyle({}, {stick: {colorscheme: "greenCarbon"}});
                    m2.setStyle({}, {stick: {colorscheme: "magentaCarbon"}});
                    m2.translate(-5, 0, 0); m1.translate(5, 0, 0);
                }
                viewer.zoomTo();
                viewer.render();
                
                // Spin
                let angle = 0;
                setInterval(() => { angle+=0.5; viewer.rotate(0.5); }, 50);

                speakReport();

            } catch (err) {
                $('#loadingOverlay').addClass('d-none');
                alert("Server Connection Error");
            }
        }

        // --- 3. GEMINI AI INTEGRATION ---
        async function askGemini(mode) {
            if (!lastAnalysis || lastAnalysis === "") {
                alert("Please run a drug simulation first!");
                return;
            }

            $('#aiLoading').removeClass('d-none').addClass('d-flex');
            synth.cancel();

            let prompt = "";
            if (mode === 'patient') {
                prompt = `You are a helpful doctor . Explain this pharmacological mechanism to a patient in simple, reassuring language. Avoid jargon. Use analogies if helpful.\n\nTechnial Report: ${lastAnalysis}`;
            } else {
                prompt = `You are a Senior Pharmacologist researcher. Provide a "Clinical Deep Dive" based on this mechanism. Discuss potential side effects, long-term implications, and relevant CYP450 metabolic considerations. Be professional and concise.\n\nTechnical Report: ${lastAnalysis}`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (data.error) {
                    alert(`DEXAGEN AI Error: ${data.error.message}`);
                    $('#aiLoading').addClass('d-none').removeClass('d-flex');
                    return;
                }

                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (aiText) {
                    // Simple formatting for bold text
                    const formattedText = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    $('#reportText').html(formattedText);
                    // Speak the new simplified/deep-dive version
                    speakReport(aiText); // Speak plain text version
                } else {
                    alert("AI could not generate a response. Please try again.");
                }

            } catch (error) {
                console.error(error);
                alert("Failed to connect to DEXAGEN AI AI.");
            } finally {
                $('#aiLoading').addClass('d-none').removeClass('d-flex');
            }
        }

        function speakReport(textOverride) {
            if (isMuted) return;
            // Use override text if provided (for AI response), otherwise use on-screen text
            const text = textOverride || $('#reportText').text();
            
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = synth.getVoices();
            const lady = voices.find(v => v.name.includes("Zira") || v.name.includes("Samantha") || v.name.includes("Google US English"));
            if(lady) utterance.voice = lady;
            utterance.rate = 0.95;
            
            utterance.onstart = () => $('#audioVisualizer').addClass('speaking');
            utterance.onend = () => $('#audioVisualizer').removeClass('speaking');
            
            synth.speak(utterance);
        }
    </script>
</body>
</html>